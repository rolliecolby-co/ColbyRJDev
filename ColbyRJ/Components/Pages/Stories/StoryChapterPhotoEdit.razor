@page "/storyChapterPhoto/edit/{PhotoId:int}"
@rendermode InteractiveServer

@layout PostEditLayout

@inject IStoryChapterRepository storyChapterRepository
@inject IStoryChapterPhotoRepository storyChapterPhotoRepository
@inject NavigationManager navManager
@attribute [Authorize]

<div class="row">
    <div class="col"></div>
    <div class="col-8">
        <HeadingC Text="Edit Story Chapter Photo" />

        @if (Photo != null && Photo.Chapter != null)
        {
            <div class="row mt-2">
                <div class="col-4 pt-2 text-center">
                    Grouped By / Story
                </div>
                <div class="col">
                    <SubHeadingC Text="@storyStr" />
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-4 pt-2 text-center">
                    Story Chapter
                </div>
                <div class="col">
                    <SubSubHeadingC Text="@storyChapterStr" />
                </div>
            </div>
        }

        <EditForm Model="Photo" OnValidSubmit="UpdatePhoto">
            <DataAnnotationsValidator />

            <div class="row mt-2">
                <div class="col-5">
                    <div class="form-group">
                        <label><b>Caption</b></label>
                        <InputText @bind-Value="Photo.Caption" class="form-control"></InputText>
                    </div>
                    <div class="form-group">
                        <label>Order Number</label>
                        <InputNumber @bind-Value="Photo.OrderBy" class="form-control"></InputNumber>
                    </div>
                    <div class="form-group mt-2">
                        <label>Photo Date</label>
                        <InputDate @bind-Value="Photo.PhotoDate" class="form-control"></InputDate>
                    </div>
                    <div class="form-group text-center mt-3">
                        <button class="btnSave">Save</button>
                        <a href="storyChapterPhotos/@Photo.StoryChapterId" class="btnReturn">Return</a>
                    </div>
                </div>
                <div class="col">
                    <div class="photo-edit">
                        <img src="@Photo.PhotoUrl" class="img-fluid" />
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
    <div class="col"></div>
</div>

@code {
    [Parameter] public int PhotoId { get; set; }
    private StoryChapterDTO Chapter { get; set; } = new StoryChapterDTO();
    private StoryChapterPhotoDTO Photo { get; set; } = new StoryChapterPhotoDTO();
    string storyStr = "";
    string storyChapterStr = "";

    protected override async Task OnParametersSetAsync()
    {
        var photo = await storyChapterPhotoRepository.GetPhoto(PhotoId);
        Photo = photo;

        var chapter = await storyChapterRepository.GetChapter(Photo.Chapter.Id);
        Chapter = chapter;

        storyStr = Chapter.Story.GroupedBy + " / " + Chapter.Story.Title;
        storyChapterStr = Chapter.Title;

        StateHasChanged();
    }

    private async Task UpdatePhoto()
    {
        var updatePhotoResult = await storyChapterPhotoRepository.Update(Photo);
        navManager.NavigateTo($"storyChapterPhotos/{@Photo.Chapter.Id}");
    }
}
