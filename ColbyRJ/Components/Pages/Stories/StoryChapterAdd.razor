@page "/storyChapter/add/{storyId:int}"
@rendermode InteractiveServer

@layout PostEditLayout

@inject IStoryRepository storyRepository
@inject IStoryChapterRepository storyChapterRepository
@inject NavigationManager navManager
@attribute [Authorize]

<div class="row ">
    <div class="col"></div>
    <div class="col-6 ">
        <HeadingC Text="Add Story Chapter" />
    </div>
    <div class="col"></div>
</div>

<div class="row mt-3">
    <div class="col"></div>
    <div class="col-6">
        <div class="row ">
            <div class="col ">
                <SubHeadingC Text="@storyStr" />
            </div>
        </div>

        <EditForm Model="Chapter" OnValidSubmit="AddChapter">
            <DataAnnotationsValidator />

            <div class="row mt-2">
                <div class="col">
                    <div class="form-group">
                        <label>Title</label>
                        <InputText @bind-Value="Chapter.Title" class="form-control"></InputText>
                        <ValidationMessage For="() => Chapter.Title"></ValidationMessage>
                    </div>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col">
                    <div class="form-group ">
                        <label>Chapter Year</label>
                        <InputNumber @bind-Value="Chapter.YearInt" class="form-control"></InputNumber>
                        <ValidationMessage For="() => Chapter.YearInt"></ValidationMessage>
                    </div>
                    <div class="col">
                        <SelectMonStrC vLabel="Chapter Month" @bind-VMonStr="@Chapter.MonStr" />
                    </div>
                    <div class="form-group mt-3 text-center">
                        <button class="btnAdd">Add Chapter</button>
                        <a href="stories" class="btnReturn">Return</a>
                    </div>
                </div>
                <div class="col">
                    <div class="alertInfo">
                        <p>
                            When completing the Add Story Chapter, a partial completion, you
                            will be directed to the Update Story Chapter page to complete the Story Chapter.
                        </p>
                    </div>
                </div>
            </div>

        </EditForm>
    </div>
    <div class="col"></div>
</div>

@code {
    [Parameter] public int StoryId { get; set; }
    private StoryDTO Story { get; set; } = new StoryDTO();
    private StoryChapterCreateDTO Chapter { get; set; } = new StoryChapterCreateDTO();
    string storyStr = "";

    protected override async Task OnParametersSetAsync()
    {
        var story = await storyRepository.GetStory(StoryId);
        Story = story;
        Chapter.StoryId = StoryId;
        storyStr = "Grouped By / Story: " + Story.GroupedBy + " / " + Story.Title;
    }

    private async Task AddChapter()
    {
        var response = await storyChapterRepository.Create(Chapter);
        if (response.Substring(0, 2) == "id")
        {
            navManager.NavigateTo($"storyChapter/edit/{response.Substring(3)}");
        }
    }
}
