@inject IFileUpload FileUpload
@inject IWebHostEnvironment Environment

<div>
    <label>Audio File</label>
</div>

@if (string.IsNullOrEmpty(filename))
{
    <div class="form-group">
        <InputFile accept=".mp3" OnChange="LoadAudio" />
    </div>
    <div class="alertInfo">
        Max Audio file size allowed is 25 mb.
        <br />
        If audio does not display and play, reduce file size and try again.
    </div>
    @if (message.Length > 0)
    {
        <div class="alert alert-danger mt-2">
            @message
        </div>
    }
}
else
{
    @if (isLoading)
    {
        <div class="col-md-12">
            <span><i class="fa fa-spin fa-spinner"></i> Please wait ... Audio is uploading ...</span>
        </div>
    }
    else
    {
        <div class="mt-3">
            <div>
                <audio controls="controls"><source src="@audioURL" /></audio>
            </div>

            <button type="button" @onclick="() => OpenDeleteAudioFileDialog(filename)" class="btnDelete mt-3">
                Delete
            </button>
        </div>
        <div class="alertInfo">
            Stop the Audio from playing prior to Deleting
        </div>

    }
}

@if (DeleteDialogOpen)
{
    <DeleteModalC Text="@Text" OnClose="@OnDeleteDialogClose" />
}

@code {
    [Parameter] public SnippetDTO Snippet { get; set; } = new SnippetDTO();
    string filename { get; set; } = "";
    bool isLoading { get; set; } = false;
    private long maxFileSize = 1024 * 1024 * 25;
    string message { get; set; } = "";
    string audioURL { get; set; }

    protected async override Task OnParametersSetAsync()
    {
        if (Snippet != null)
        {
            filename = Snippet.AudioFilename;
            audioURL = Snippet.AudioUrl;
        }
    }

    async Task LoadAudio(InputFileChangeEventArgs e)
    {
        isLoading = true;
        message = "";

        var audioFile = e.File;

        if (e.File.Size > maxFileSize)
        {
            message = "Selected File is too large";
        }
        else
        {
            var newFileName = Guid.NewGuid().ToString() + ".mp3";
            filename = newFileName;

            var path = Path.Combine(Environment.WebRootPath,
                "snippetAudio", newFileName);

            await using FileStream fs = new(path, FileMode.Create);
            await audioFile.OpenReadStream(maxFileSize).CopyToAsync(fs);

            audioURL = "snippetAudio/" + newFileName;

            Snippet.AudioFilename = newFileName;
            Snippet.AudioUrl = audioURL;
        }

        isLoading = false;
    }

    public bool DeleteDialogOpen { get; set; }
    public string Text { get; set; }
    string audioFileToDelete;

    async Task OnDeleteDialogClose(bool accepted)
    {
        if (accepted)
        {
            try
            {
                var result = FileUpload.DeleteFile(audioFileToDelete, "snippetAudio");
            }
            catch
            { }

            filename = "";
            audioURL = "";
            Snippet.AudioFilename = "";
            Snippet.AudioUrl = "";
        }
        DeleteDialogOpen = false;
        StateHasChanged();
    }

    private void OpenDeleteAudioFileDialog(string audioFilename)
    {
        DeleteDialogOpen = true;
        audioFileToDelete = audioFilename;
        Text = "Do you want to delete this Audio File?";
        StateHasChanged();
    }
}
