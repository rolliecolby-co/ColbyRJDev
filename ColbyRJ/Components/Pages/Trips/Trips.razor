@page "/trips"
@rendermode InteractiveServer

@layout PostEditLayout

@inject ITripRepository tripRepository
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject IAppUserRepository appUserRepository
@inject NavigationManager navManager
@attribute [Authorize]

<div class="row ">
    <div class="col mb-2 ">
        <HeadingC Text="Trips" />
    </div>
    <div class=" mb-2 text-center" style="width: 200px;">
        <a href="trip/add" class="btnAdd"><span>&#43;</span> Add New Trip</a>
    </div>
</div>

@if (IsLoading)
{
    <div class="mt-3">
        <h5>Loading ...</h5>
    </div>
}

@if (trips != null && trips.Any())
{
    <div class="row  mt-3">
        <div class="col ">
            <table>
                <tr>
                    <th style="width: 100px;">
                        When
                    </th>
                    <th>
                    </th>
                    <th style="width: 60px;">
                        Title
                    </th>
                    <th style="width: 60px;">
                        Group
                    </th>
                    <th style="width: 60px;">
                        Section
                    </th>
                    <th>
                        SubSection
                    </th>
                    <th style="width: 60px;">
                        Comments
                    </th>
                    <th style="width: 90px;">
                        Sort
                    </th>
                    <th style="width: 60px;">
                        Photos
                    </th>
                    <th style="width: 60px;">
                        Active
                    </th>
                    <th style="width: 60px;">
                    </th>
                    <th style="width: 180px;">
                    </th>
                    <th >
                    </th>
                </tr>
                @foreach (var item in AllTrips)
                {
                    <tr>
                        <td class="text-center">
                            @item.YearMon
                        </td>
                        <td class="">
                            @if (item.TripGroups != null && item.TripGroups.Any() && expandTripId != item.Id)
                            {
                                <button type="button" class="btnEdit btn-sm" onclick="@(() => ExpandTrip(item.Id))">
                                    &#43;
                                </button>
                            }
                        </td>
                        <td colspan="4">
                            @item.Title
                        </td>
                        <td class="text-center">
                            @item.CommentCount
                        </td>
                        <td>
                        </td>
                        <td class="text-center">
                            @item.PhotoCount
                        </td>
                        <td class="text-center">
                            @item.ActiveStr
                        </td>
                        <td class="text-center">
                            <a href="@($"trip/edit/{item.Id}")" class="btnEdit">
                                Edit
                            </a>
                        </td>
                        <td class="text-start">
                            <a href="@($"trip/Group/{item.Id}/add")" class="btnAdd text-nowrap">
                                &#43; Group
                            </a>
                        </td>
                        <td>
                            @if (item.TripGroups == null || !item.TripGroups.Any())
                            {
                                <button type="button" class="btnDelete btn-sm" onclick="@(() => OpenDeleteTripDialog(item.Id))">
                                    Delete
                                </button>
                            }
                        </td>
                    </tr>
                    @if (expandTripId == item.Id)
                    {
                        @foreach (var item2 in Groups)
                        {
                            if (item.Id == item2.TripId)
                            {
                                <tr>
                                    <td>
                                        &nbsp;
                                    </td>
                                    <td>
                                        &nbsp;
                                    </td>
                                    <td>
                                        &nbsp;
                                    </td>
                                    <td colspan="4">
                                        @item2.Name
                                    </td>
                                    <td class="text-start">
                                        @item2.Sort
                                    </td>
                                    <td class="text-center">
                                        @item2.PhotoCount
                                    </td>
                                    <td>
                                        &nbsp;
                                    </td>
                                    <td class="text-center">
                                        <a href="@($"tripGroup/edit/{item2.Id}")" class="btnEdit">
                                            Edit
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <a href="@($"trip/Section/{item2.Id}/add")" class="btnAdd text-nowrap">
                                            &#43; Section
                                        </a>
                                    </td>
                                    <td>
                                        @if (item2.TripSections == null || !item2.TripSections.Any())
                                        {
                                            <button type="button" class="btnDelete btn-sm" onclick="@(() => OpenDeleteTripGroupDialog(item2.Id))">
                                                Delete
                                            </button>
                                        }
                                    </td>
                                </tr>
                                @foreach (var item3 in Sections)
                                {
                                    if (item2.Id == item3.TripGroupId)
                                    {
                                        <tr>
                                            <td>
                                                &nbsp;
                                            </td>
                                            <td>
                                                &nbsp;
                                            </td>
                                            <td>
                                                &nbsp;
                                            </td>
                                            <td>
                                                &nbsp;
                                            </td>
                                            <td colspan="3">
                                                @item3.Name
                                            </td>
                                            <td class="text-center">
                                                @item3.Sort
                                            </td>
                                            <td class="text-center">
                                                @item3.PhotoCount
                                            </td>
                                            <td>
                                                &nbsp;
                                            </td>
                                            <td class="text-center">
                                                <a href="@($"tripSection/edit/{item3.Id}")" class="btnEdit">
                                                    Edit
                                                </a>
                                            </td>
                                            <td class="text-end">
                                                <a href="@($"trip/SubSection/{item3.Id}/add")" class="btnAdd text-nowrap">
                                                    &#43; SubSection
                                                </a>
                                            </td>
                                            <td>
                                                @if (item3.TripSubSections == null || !item3.TripSubSections.Any())
                                                {
                                                    <button type="button" class="btnDelete btn-sm" onclick="@(() => OpenDeleteTripSectionDialog(item3.Id))">
                                                        Delete
                                                    </button>
                                                }
                                            </td>
                                        </tr>
                                        @foreach (var item4 in SubSections)
                                        {
                                            if (item3.Id == item4.TripSectionId)
                                            {
                                                <tr>
                                                    <td>
                                                        &nbsp;
                                                    </td>
                                                    <td>
                                                        &nbsp;
                                                    </td>
                                                    <td>
                                                        &nbsp;
                                                    </td>
                                                    <td>
                                                        &nbsp;
                                                    </td>
                                                    <td>
                                                        &nbsp;
                                                    </td>
                                                    <td colspan="2">
                                                        @item4.Name
                                                    </td>
                                                    <td class="text-end">
                                                        @item4.Sort
                                                    </td>
                                                    <td class="text-center">
                                                        @item4.PhotoCount
                                                    </td>
                                                    <td>
                                                        &nbsp;
                                                    </td>
                                                    <td class="text-center">
                                                        <a href="@($"tripSubSection/edit/{item4.Id}")" class="btnEdit">
                                                            Edit
                                                        </a>
                                                    </td>
                                                    <td>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btnDelete btn-sm" onclick="@(() => OpenDeleteTripSubSectionDialog(item4.Id))">
                                                            Delete
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            </table>

        </div>
    </div>
}

@if (DeleteDialogOpen)
{
    <DeleteModalC Text="@Text" OnClose="@OnDeleteDialogClose" />
}

@code {
    private List<TripDTO> trips { get; set; } = new List<TripDTO>();
    private List<TripDTO> AllTrips { get; set; } = new List<TripDTO>();
    private List<TripGroupDTO> Groups { get; set; } = new List<TripGroupDTO>();
    private List<TripSectionDTO> Sections { get; set; } = new List<TripSectionDTO>();
    private List<TripSubSectionDTO> SubSections { get; set; } = new List<TripSubSectionDTO>();
    private string userEmail = "";
    private string userRole = "";
    public bool IsLoading { get; set; } = true;
    int expandTripId = 0;

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;
        await LoadPage();

        var authstate = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
        var user = authstate.User;
        userEmail = user.Identity.Name;
        var appUser = await appUserRepository.GetUserByEmail(userEmail);
        if (appUser != null)
        {
            userRole = appUser.Role;
        }
        IsLoading = false;
    }

    private async Task LoadPage()
    {
        trips = new List<TripDTO>();
        AllTrips = new List<TripDTO>();
        Groups = new List<TripGroupDTO>();
        Sections = new List<TripSectionDTO>();
        SubSections = new List<TripSubSectionDTO>();

        await LoadTrips();
        await LoadGroups();
        await LoadSections();
        await LoadSubSections();
    }

    private async Task LoadTrips()
    {
        var tTrips = await tripRepository.GetTrips();
        trips = tTrips.ToList();
        AllTrips = trips;
    }

    private async Task LoadGroups()
    {
        var tGroups = await tripRepository.GetTripGroups();
        Groups = tGroups.ToList();
        Groups = Groups
            .OrderBy(q => q.Sort)
            .ThenBy(q => q.Name)
            .ToList();
    }

    private async Task LoadSections()
    {
        var tSections = await tripRepository.GetTripSections();
        Sections = tSections.ToList();
        Sections = Sections
            .OrderBy(q => q.Sort)
            .ThenBy(q => q.Name)
            .ToList();
    }

    private async Task LoadSubSections()
    {
        var tSubSections = await tripRepository.GetTripSubSections();
        SubSections = tSubSections.ToList();
        SubSections = SubSections
            .OrderBy(q => q.Sort)
            .ThenBy(q => q.Name)
            .ToList();
    }

    private void ExpandTrip(int id)
    {
        expandTripId = id;
        StateHasChanged();
    }

    public bool DeleteDialogOpen { get; set; }
    public string Text { get; set; }
    private int DeleteTripId { get; set; } = 0;
    private int DeleteTripGroupId { get; set; } = 0;
    private int DeleteTripSectionId { get; set; } = 0;
    private int DeleteTripSubSectionId { get; set; } = 0;

    async Task OnDeleteDialogClose(bool accepted)
    {
        if (accepted)
        {
            if (DeleteTripId > 0)
            {
                await tripRepository.DeleteTrip(DeleteTripId);
            }
            if (DeleteTripGroupId > 0)
            {
                await tripRepository.DeleteTripGroup(DeleteTripGroupId);
            }
            if (DeleteTripSectionId > 0)
            {
                await tripRepository.DeleteTripSection(DeleteTripSectionId);
            }
            if (DeleteTripSubSectionId > 0)
            {
                await tripRepository.DeleteTripSubSection(DeleteTripSubSectionId);
            }
            DeleteDialogOpen = false;
            await LoadPage();
        }
        DeleteDialogOpen = false;
        StateHasChanged();
    }

    private void OpenDeleteTripDialog(int id)
    {
        DeleteDialogOpen = true;
        DeleteTripId = id;
        DeleteTripGroupId = 0;
        DeleteTripSectionId = 0;
        DeleteTripSubSectionId = 0;
        Text = "Do you want to delete this Trip Group?";
        StateHasChanged();
    }

    private void OpenDeleteTripGroupDialog(int id)
    {
        DeleteDialogOpen = true;
        DeleteTripId = 0;
        DeleteTripGroupId = id;
        DeleteTripSectionId = 0;
        DeleteTripSubSectionId = 0;
        Text = "Do you want to delete this Trip Group?";
        StateHasChanged();
    }

    private void OpenDeleteTripSectionDialog(int id)
    {
        DeleteDialogOpen = true;
        DeleteTripId = 0;
        DeleteTripGroupId = 0;
        DeleteTripSectionId = id;
        DeleteTripSubSectionId = 0;
        Text = "Do you want to delete this Trip Section?";
        StateHasChanged();
    }

    private void OpenDeleteTripSubSectionDialog(int id)
    {
        DeleteDialogOpen = true;
        DeleteTripId = 0;
        DeleteTripGroupId = 0;
        DeleteTripSectionId = 0;
        DeleteTripSubSectionId = id;
        Text = "Do you want to delete this Trip SubSection?";
        StateHasChanged();
    }
}
