@page "/docPdfs/{docId:int}"

@layout EditLayout
@inject IDocRepository docRepository
@inject IDocPdfRepository docPdfRepository
@attribute [Authorize]

<div class="row  mb-2 pt-2">
    <div class="col-10">
        <HeadingC Text="Document PDFs" />
    </div>
    <div class="col text-center">
        <a href="doc/edit/@DocId" class="btnReturn">Return</a>
    </div>
</div>

@if (Doc != null && Pdfs != null && Pdfs.Any())
{
    <div class="row ">
        <div class="col-3 text-center">
            Grouped By: @Doc.GroupedBy
        </div>
        <div class="col-3 text-center">
            Document: <b>@Doc.Title</b>
        </div>
    </div>
    <div class="row mt-3">
        @foreach (var item in Pdfs)
        {
            <div class="col-4">
                <div class="pdfCard">
                    <div class="pdfCaption text-center mt-2 mb-1">
                        @item.Title
                    </div>
                    <div class="pdfBody text-center">
                        <embed src="@item.PdfUrl" style="width: 100%; height: 850px;" />
                    </div>
                    <div class="pdfFooter">
                        <div class="row">
                            <div class="col text-center">
                                @item.OrderBy
                            </div>
                            <div class="col text-center">
                                @item.PdfDateStr
                            </div>
                            <div class="col text-end">
                                <a href="@($"docPdf/edit/{item.Id}")" class="btnEdit">Edit</a>
                                <button type="button" class="btnDelete btn-sm" onclick="@(() => OpenDeleteDocPdfDialog(item.Id))">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@if (DeleteDialogOpen)
{
    <DeleteModalC Text="@Text" OnClose="@OnDeleteDialogClose" />
}

@code {
    [Parameter] public int DocId { get; set; }
    private DocDTO Doc { get; set; } = new DocDTO();
    List<DocPdfDTO> Pdfs { get; set; } = new List<DocPdfDTO>();
    private int DeleteDocPdfId { get; set; } = 0;

    protected async override Task OnParametersSetAsync()
    {
        var doc = await docRepository.GetDoc(DocId);
        Doc = doc;

        await LoadDocPdfs();
        StateHasChanged();
    }

    private async Task LoadDocPdfs()
    {
        var pdfs = await docPdfRepository.GetPdfs(DocId);
        Pdfs = pdfs.ToList();
    }

    public bool DeleteDialogOpen { get; set; }
    public string Text { get; set; }

    async Task OnDeleteDialogClose(bool accepted)
    {
        if (accepted)
        {
            await docPdfRepository.Delete(DeleteDocPdfId);
            DeleteDialogOpen = false;
            await LoadDocPdfs();
        }
        DeleteDialogOpen = false;
        StateHasChanged();
    }

    private void OpenDeleteDocPdfDialog(int id)
    {
        DeleteDialogOpen = true;
        DeleteDocPdfId = id;
        Text = "Do you want to delete this Document PDF?";
        StateHasChanged();
    }

}
