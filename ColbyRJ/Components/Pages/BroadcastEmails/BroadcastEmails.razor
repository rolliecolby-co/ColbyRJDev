@page "/broadcastEmails"
@rendermode InteractiveServer

@layout PostEditLayout

@inject IBroadcastEmailRepository broadcastEmailRepository
@inject AuthenticationStateProvider GetAuthenticationStateAsync
@inject IAppUserRepository appUserRepository
@inject NavigationManager navManager
@attribute [Authorize]

<div class="row ">
    <div class="col mb-2 pt-2">
        <HeadingC Text="Broadcast Emails" />
    </div>
    <div class=" mb-2 text-center" style="width: 280px;">
        @if (okToSend)
        {
            <a href="broadcastEmail/add" class="btnSend">Send New Broadcast Email</a>
        }
        else
        {
            <p class="mt-3">
                Please wait an hour; limited by number of emails sent per hour.
            </p>
        }
    </div>
</div>

<div class="row mt-1">
    <div class="col mt-2">
        <RadzenDataGrid PageSize="15" AllowPaging="true" Data="@broadcastEmails" TItem="BroadcastEmailDTO"
                        PagerHorizontalAlign="HorizontalAlign.Center">
            <Columns>
                <RadzenDataGridColumn Property="DateSentStr" Title="Date Sent" Width="120px"
                    HeaderCssClass="rz-background-color-info-lighter" />
                <RadzenDataGridColumn Property="SentTo" Title="Sent To" HeaderCssClass="rz-background-color-info-lighter" />
                <RadzenDataGridColumn Property="Subject" Title="Subject" HeaderCssClass="rz-background-color-info-lighter" />
                <RadzenDataGridColumn Property="SentBy" Title="Sent By" Width="120px"
                                      HeaderCssClass="rz-background-color-info-lighter" />

                <RadzenDataGridColumn Property="Id" Width="70px" TextAlign="TextAlign.Center"
                                      HeaderCssClass="rz-background-color-info-lighter">
                    <Template Context="data">
                        @{
                            var link = "broadcastEmail/" + data.Id;
                        }
                        <RadzenLink Path=@link Text="View" />
                    </Template>
                </RadzenDataGridColumn>
                @if (userRole == "Admin")
                {
                    <RadzenDataGridColumn Property="Id" Width="70px"
                                          HeaderCssClass="rz-background-color-info-lighter">
                        <Template Context="data">
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter" Icon="delete" class="m-1"
                                          Click=@(() => DeleteBroadcastEmail(data.Id)) />
                        </Template>
                    </RadzenDataGridColumn>
                }
            </Columns>
        </RadzenDataGrid>
    </div>
</div>

@if (DeleteDialogOpen)
{
    <DeleteModalC Text="@Text" OnClose="@OnDeleteDialogClose" />
}

@code {
    private List<BroadcastEmailDTO> broadcastEmails { get; set; } = new List<BroadcastEmailDTO>();
    private int DeleteBroadcastEmailId { get; set; } = 0;
    public string userEmail = "";
    public string userRole = "";
    public string sentBy = "";
    bool okToSend = false;

    protected override async Task OnInitializedAsync()
    {
        var response = await broadcastEmailRepository.OkToSend();
        okToSend = response;

        await LoadBroadcastEmails();

        var authstate = await GetAuthenticationStateAsync.GetAuthenticationStateAsync();
        var user = authstate.User;
        userEmail = user.Identity.Name;
        var appUser = await appUserRepository.GetUserByEmail(userEmail);
        if (appUser != null)
        {
            userRole = appUser.Role;
            sentBy = appUser.DisplayName;
        }
    }

    private async Task LoadBroadcastEmails()
    {
        var tBroadcastEmails = await broadcastEmailRepository.GetBroadcastEmails();
        broadcastEmails = tBroadcastEmails.ToList();
    }

    async Task DeleteBroadcastEmail(int Id)
    {
        OpenDeleteBroadcastEmailDialog(Id);
    }

    public bool DeleteDialogOpen { get; set; }
    public string Text { get; set; }

    async Task OnDeleteDialogClose(bool accepted)
    {
        if (accepted)
        {
            await broadcastEmailRepository.Delete(DeleteBroadcastEmailId);
            DeleteDialogOpen = false;
            await LoadBroadcastEmails();
        }
        DeleteDialogOpen = false;
        StateHasChanged();
    }

    private void OpenDeleteBroadcastEmailDialog(int id)
    {
        DeleteDialogOpen = true;
        DeleteBroadcastEmailId = id;
        Text = "Do you want to delete this Broadcast Email?";
        StateHasChanged();
    }

}
