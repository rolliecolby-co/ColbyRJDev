@page "/broadcastEmail/add"
@rendermode InteractiveServer

@layout PostEditLayout

@inject IAppUserRepository userRepository
@inject IBroadcastEmailRepository broadcastEmailRepository
@inject NavigationManager navManager
@attribute [Authorize]

<div class="row ">
    <div class="col"></div>
    <div class="col-8">
        <HeadingC Text="New Broadcast Email" />
    </div>
    <div class="col"></div>
</div>

@if (okToSend)
{
    <div class="row mt-2">
        <div class="col"></div>
        <div class="col-8">
            <EditForm Model="BroadcastEmail" OnValidSubmit="AddBroadcastEmail">
                <DataAnnotationsValidator />
                <div class="row mt-2">
                    <div class="col">
                        <div class="">
                            <label><b>Check Send To(s)</b></label>
                            <div>
                                <span class="p-2">
                                    <input type="checkbox" @onchange="args => ToggleAll(args, strAll)" />
                                </span>
                                <span class="p-2">@strAll</span>
                            </div>
                            <CheckBoxList Data="@users"
                                          TextField="@((item)=>item.DisplayName)"
                                          ValueField="@((item)=>item.Id)"
                                          SelectedValues="@SelectedIds" />
                        </div>
                        <div class="mt-3 text-center">
                            <div class="form-group pt-3">
                                @if (!emailSent)
                                {
                                    <button class="btnSend">Send Email</button>
                                }
                                <a href="broadcastEmails" class="btnReturn ms-2">Return</a>
                            </div>
                        </div>
                        @if (errorSendTo)
                        {
                            <div class="mt-3">
                                <div class="alert alert-danger">
                                    Check at least one Send To
                                </div>
                            </div>
                        }
                        @if (emailSent)
                        {
                            <div class="mt-3">
                                <div class="alert alert-success">
                                    Email Sent
                                </div>
                            </div>
                        }
                    </div>
                    <div class="col-8">
                        <div class="form-group">
                            <label>Subject</label>
                            <InputText @bind-Value="BroadcastEmail.Subject" class="form-control"></InputText>
                            <ValidationMessage For="() => BroadcastEmail.Subject"></ValidationMessage>
                        </div>
                        <div class="form-group mt-2">
                            <label>The Message</label>
                            <RZHtmlEditorMinC @bind-HtmlValue="@BroadcastEmail.Message" Height="500px" />
                            <ValidationMessage For="() => BroadcastEmail.Message"></ValidationMessage>
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
        <div class="col"></div>
    </div>
}
else
{
    <div class="row mt-2">
        <div class="col"></div>
        <div class="col-7">
            <h3>Please wait an hour; limited by number of emails sent per hour.</h3>
        </div>
        <div class="col"></div>
    </div>

}

@code {
    private BroadcastEmailDTO BroadcastEmail { get; set; } = new BroadcastEmailDTO();
    private List<AppUserDTO> users;
    protected List<string> SelectedIds = new List<string>();
    public string OutPutValue { get; set; }
    public string strAll = "All";
    bool errorSendTo = false;
    bool emailSent = false;
    bool okToSend = false;

    protected override async Task OnInitializedAsync()
    {
        var response = await broadcastEmailRepository.OkToSend();
        okToSend = response;

        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        var tUsers = await userRepository.GetUsers();
        users = tUsers.ToList();
    }

    private async Task AddBroadcastEmail()
    {
        errorSendTo = false;
        emailSent = false;

        if (SelectedIds.Count == 0)
        {
            errorSendTo = true;
        }
        else
        {
            BroadcastEmail.UserIDs = SelectedIds;
            var response = await broadcastEmailRepository.Create(BroadcastEmail);
            if (response.Substring(0, 2) == "id")
            {
                emailSent = true;
            }
        }
        StateHasChanged();
    }

    async Task ToggleAll(ChangeEventArgs args, string item)
    {
        bool IsSelected = (bool)args.Value;
        if (IsSelected) SelectedIds.Add(item);
        else SelectedIds.Remove(item);
    }

    protected void ShowSelectedValues()
    {
        OutPutValue = string.Join(", ", SelectedIds.ToArray());
        StateHasChanged();
    }
}
