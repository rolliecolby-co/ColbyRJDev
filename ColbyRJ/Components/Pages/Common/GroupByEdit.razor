@page "/groupBy/edit/{element}/{id:int}"

@layout PostEditLayout

@inject IDocRepository docRepository
@inject IPhotoAlbumRepository photoAlbumRepository
@inject IPhotoFolderRepository photoFolderRepository
@inject ISnippetRepository snippetRepository
@inject IStoryRepository storyRepository
@inject ITripRepository tripRepository
@inject IVideoRepository videoRepository

@inject ICategoryRepository categoryRepository
@inject ISectionRepository sectionRepository
@inject ITopicRepository topicRepository
@inject NavigationManager navManager
@attribute [Authorize]

<div class="row">
    <HeadingC Text="@pageHeading" />
</div>
<div class="row mt-3">
    <div class="col"></div>
    <div class="col-10">
        <SubHeadingC Text="@elementTitle" />
    </div>
    <div class="col"></div>
</div>

<div class="row mt-2">
    <div class="col"></div>
    <div class="col-8">
        <EditForm Model="GroupBy" OnValidSubmit="UpdateGroupBy">
            <DataAnnotationsValidator />

            <div class="row mt-2">
                <div class="col">
                    <div class="form-group">
                        <label>Category - Select a Category</label>
                        <InputSelect Value="@category"
                                     ValueChanged="@((string value) => CategoryChanged(value))"
                                     ValueExpression="@(() => category)"
                                     class="form-select">
                            <option value="">-- Select a Category --</option>
                            @foreach (var cat in Categories)
                            {
                                <option value="@cat.Name">@cat.Name</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="() => Snippet.Category"></ValidationMessage>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Section</label>
                        <InputSelect Value="@vSection"
                                     ValueChanged="@((string value) => SectionChanged(value))"
                                     ValueExpression="@(() => vSection)"
                                     class="form-select">
                            <option value="" selected>-- Select Section --</option>
                            @foreach (var var in Sections)
                            {
                                <option value="@var">@var</option>
                            }
                        </InputSelect>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Topic</label>
                        <InputSelect @bind-Value="GroupBy.Topic"
                                     class="form-select">
                            <option value="" selected>-- Select Topic --</option>
                            @foreach (var topic in Topics)
                            {
                                <option value="@topic">@topic</option>
                            }
                        </InputSelect>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <div class="form-group text-center">
                        <button class="btnUpdate">Update</button>
                        <a href="@returnUrl" class="btnReturn ms-3">Return</a>
                    </div>
                </div>
            </div>
        </EditForm>
    </div>
    <div class="col"></div>
</div>

@code {
    [Parameter] public string Element { get; set; }
    [Parameter] public int Id { get; set; }
    string pageHeading = "";
    string elementTitle = "";
    string returnUrl = "";
    private GroupByEditDTO GroupBy { get; set; } = new GroupByEditDTO();

    private DocDTO Doc { get; set; } = new DocDTO();
    private PhotoAlbumDTO PhotoAlbum { get; set; } = new PhotoAlbumDTO();
    private PhotoFolderDTO PhotoFolder { get; set; } = new PhotoFolderDTO();
    private SnippetDTO Snippet { get; set; } = new SnippetDTO();
    private StoryDTO Story { get; set; } = new StoryDTO();
    private TripDTO Trip { get; set; } = new TripDTO();
    private VideoDTO Video { get; set; } = new VideoDTO();

    private List<CategoryDTO> Categories { get; set; } = new List<CategoryDTO>();
    private List<string> Sections { get; set; } = new List<string>();
    private List<string> Topics { get; set; } = new List<string>();
    string category = "";
    string vSection = "";
    string topic = "";

    protected override async Task OnParametersSetAsync()
    {
        var categories = await categoryRepository.GetCategories();
        Categories = categories.ToList();

        if (Element == "doc")
        {
            var doc = await docRepository.GetDoc(Id);
            Doc = doc;
            pageHeading = "Edit Document Grouped By";
            elementTitle = Doc.Title;
            GroupBy.Id = Id;
            returnUrl = "doc/edit/" + Id.ToString();

            category = Doc.Category.ToString();
            GroupBy.Category = category;
            vSection = Doc.Section.ToString();
            GroupBy.Section = vSection;
            topic = Doc.Topic.ToString();
            GroupBy.Topic = topic;
        }
        else if (Element == "photoAlbum")
        {
            var photoAlbum = await photoAlbumRepository.GetPhotoAlbum(Id);
            PhotoAlbum = photoAlbum;
            pageHeading = "Edit Photo Album Grouped By";
            elementTitle = PhotoAlbum.Title;
            GroupBy.Id = Id;
            returnUrl = "photoAlbum/edit/" + Id.ToString();

            category = PhotoAlbum.Category.ToString();
            GroupBy.Category = category;
            vSection = PhotoAlbum.Section.ToString();
            GroupBy.Section = vSection;
            topic = PhotoAlbum.Topic.ToString();
            GroupBy.Topic = topic;
        }
        else if (Element == "photoFolder")
        {
            var photoFolder = await photoFolderRepository.GetPhotoFolder(Id);
            PhotoFolder = photoFolder;
            pageHeading = "Edit Photo Folder Grouped By";
            elementTitle = PhotoFolder.Title;
            GroupBy.Id = Id;
            returnUrl = "photoFolder/edit/" + Id.ToString();

            category = PhotoFolder.Category.ToString();
            GroupBy.Category = category;
            vSection = PhotoFolder.Section.ToString();
            GroupBy.Section = vSection;
            topic = PhotoFolder.Topic.ToString();
            GroupBy.Topic = topic;
        }
        else if (Element == "snippet")
        {
            var snippet = await snippetRepository.GetSnippet(Id);
            Snippet = snippet;
            pageHeading = "Edit Snippet Grouped By";
            elementTitle = Snippet.Title;
            GroupBy.Id = Id;
            returnUrl = "snippet/edit/" + Id.ToString();

            category = Snippet.Category.ToString();
            GroupBy.Category = category;
            vSection = Snippet.Section.ToString();
            GroupBy.Section = vSection;
            topic = Snippet.Topic.ToString();
            GroupBy.Topic = topic;
        }
        else if (Element == "story")
        {
            var story = await storyRepository.GetStory(Id);
            Story = story;
            pageHeading = "Edit Story Grouped By";
            elementTitle = Story.Title;
            GroupBy.Id = Id;
            returnUrl = "story/edit/" + Id.ToString();

            category = Story.Category.ToString();
            GroupBy.Category = category;
            vSection = Story.Section.ToString();
            GroupBy.Section = vSection;
            topic = Story.Topic.ToString();
            GroupBy.Topic = topic;
        }
        else if (Element == "trip")
        {
            var trip = await tripRepository.GetTrip(Id);
            Trip = trip;
            pageHeading = "Edit Trip Grouped By";
            elementTitle = Trip.Title;
            GroupBy.Id = Id;
            returnUrl = "trip/edit/" + Id.ToString();

            category = Trip.Category.ToString();
            GroupBy.Category = category;
            vSection = Trip.Section.ToString();
            GroupBy.Section = vSection;
            topic = Trip.Topic.ToString();
            GroupBy.Topic = topic;
        }
        else if (Element == "video")
        {
            var video = await videoRepository.GetVideo(Id);
            Video = video;
            pageHeading = "Edit Video Grouped By";
            elementTitle = Video.Title;
            GroupBy.Id = Id;
            returnUrl = "video/edit/" + Id.ToString();

            category = Video.Category.ToString();
            GroupBy.Category = category;
            vSection = Video.Section.ToString();
            GroupBy.Section = vSection;
            topic = Video.Topic.ToString();
            GroupBy.Topic = topic;
        }

        await LoadSections(category);

        if (vSection.Length > 0)
        {
            await LoadTopics(vSection);
        }

    }

    private async Task UpdateGroupBy()
    {
        if (Element == "doc")
        {
            await docRepository.UpdateGroupBy(GroupBy);
        }
        else if (Element == "photoAlbum")
        {
            await photoAlbumRepository.UpdateGroupBy(GroupBy);
        }
        else if (Element == "photoFolder")
        {
            await photoFolderRepository.UpdateGroupBy(GroupBy);
        }
        else if (Element == "snippet")
        {
            await snippetRepository.UpdateGroupBy(GroupBy);
        }
        else if (Element == "story")
        {
            await storyRepository.UpdateGroupBy(GroupBy);
        }
        else if (Element == "trip")
        {
            await tripRepository.UpdateGroupBy(GroupBy);
        }
        else if (Element == "video")
        {
            await videoRepository.UpdateGroupBy(GroupBy);
        }
        navManager.NavigateTo(returnUrl);
    }

    private async void CategoryChanged(string value)
    {
        category = value;
        GroupBy.Category = category;
        GroupBy.Section = string.Empty;
        vSection = "";
        GroupBy.Topic = string.Empty;
        topic = "";

        await LoadSections(value);
        StateHasChanged();
    }

    private async void SectionChanged(string value)
    {
        vSection = value;
        GroupBy.Section = vSection;
        GroupBy.Topic = string.Empty;
        topic = "";

        await LoadTopics(value);
        StateHasChanged();
    }

    private async Task LoadSections(string category)
    {
        var sections = await sectionRepository.GetCategorySectionsStr(category);
        Sections = sections.ToList();
    }

    private async Task LoadTopics(string category)
    {
        var topics = await topicRepository.GetSectionTopicsStr(category);
        Topics = topics.ToList();
    }
}
